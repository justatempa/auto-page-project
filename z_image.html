<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Image-Turbo Generator (Pyrite Fixed)</title>
    <style>
        /* 样式部分保持原汁原味，没动你的心头好 */
        * { margin: 0; padding: 0; box-sizing: border-box; } 
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); 
            min-height: 100vh; 
            color: #fff; 
        } 
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; } 
        header { text-align: center; padding: 20px 0; } 
        header h1 { 
            font-size: 2.2rem; 
            background: linear-gradient(90deg, #00d4ff, #7b2cbf); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        } 
        header p { color: #888; font-size: 0.95rem; } 
        .main-content { 
            display: grid; 
            grid-template-columns: 380px 1fr; 
            gap: 25px; 
            margin-top: 15px; 
        } 
        @media (max-width: 1000px) { .main-content { grid-template-columns: 1fr; } } 
        .panel { 
            background: rgba(255, 255, 255, 0.05); 
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
        } 
        .panel h2 { font-size: 1.1rem; margin-bottom: 16px; color: #00d4ff; } 
        .form-group { margin-bottom: 16px; } 
        .form-group label { display: block; margin-bottom: 6px; color: #ccc; font-size: 0.85rem; } 
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 10px 14px; border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 8px; background: rgba(0, 0, 0, 0.3); color: #fff; font-size: 0.95rem; transition: all 0.3s; 
        } 
        .form-group textarea { min-height: 100px; resize: vertical; font-family: inherit; } 
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; border-color: #00d4ff; box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2); 
        } 
        .inline-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; } 
        .ratio-tabs { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; } 
        .ratio-tab { 
            padding: 6px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; 
            background: transparent; color: #888; cursor: pointer; font-size: 0.8rem; transition: all 0.3s; 
        } 
        .ratio-tab:hover { border-color: #00d4ff; color: #ccc; } 
        .ratio-tab.active { border-color: #00d4ff; background: rgba(0, 212, 255, 0.2); color: #00d4ff; } 
        .size-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; } 
        .size-btn { 
            padding: 8px 4px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; 
            background: rgba(0, 0, 0, 0.3); color: #aaa; cursor: pointer; transition: all 0.3s; 
            font-size: 0.75rem; text-align: center; 
        } 
        .size-btn:hover { border-color: #00d4ff; color: #fff; } 
        .size-btn.active { border-color: #00d4ff; background: rgba(0, 212, 255, 0.2); color: #00d4ff; } 
        .size-btn .dimensions { font-weight: 600; display: block; } 
        .size-btn .label { font-size: 0.65rem; color: #666; margin-top: 2px; } 
        .size-btn.active .label { color: #00d4ff; } 
        .custom-size { 
            display: none; margin-top: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; 
        } 
        .custom-size.show { display: block; } 
        .custom-size-inputs { display: flex; align-items: center; gap: 10px; } 
        .custom-size-inputs input { width: 80px; padding: 8px; text-align: center; } 
        .custom-size-inputs span { color: #666; } 
        .generate-btn { 
            width: 100%; padding: 14px; border: none; border-radius: 10px; 
            background: linear-gradient(90deg, #00d4ff, #7b2cbf); color: #fff; font-size: 1rem; 
            font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; 
            align-items: center; justify-content: center; gap: 10px; 
        } 
        .generate-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3); } 
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; } 
        .progress-section { 
            display: none; margin-top: 16px; padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; 
        } 
        .progress-section.show { display: block; } 
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; } 
        .progress-status { font-size: 0.9rem; color: #00d4ff; } 
        .progress-time { font-size: 0.85rem; color: #888; font-family: monospace; } 
        .progress-bar-container { height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; } 
        .progress-bar { 
            height: 100%; background: linear-gradient(90deg, #00d4ff, #7b2cbf); 
            border-radius: 3px; transition: width 0.3s; width: 0%; 
        } 
        .progress-bar.indeterminate { width: 30%; animation: indeterminate 1.5s infinite ease-in-out; } 
        @keyframes indeterminate { 0% { transform: translateX(-100%); } 100% { transform: translateX(400%); } } 
        .progress-steps { display: flex; justify-content: space-between; margin-top: 12px; font-size: 0.75rem; } 
        .progress-step { display: flex; align-items: center; gap: 5px; color: #555; } 
        .progress-step.active { color: #00d4ff; } 
        .progress-step.done { color: #4caf50; } 
        .step-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; } 
        .progress-step.active .step-dot { background: #00d4ff; box-shadow: 0 0 8px #00d4ff; } 
        .progress-step.done .step-dot { background: #4caf50; } 
        .status-bar { margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 0.85rem; display: none; } 
        .status-bar.error { display: block; background: rgba(255, 82, 82, 0.2); border: 1px solid rgba(255, 82, 82, 0.3); color: #ff5252; } 
        .status-bar.success { display: block; background: rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.3); color: #4caf50; } 
        .gallery { min-height: 400px; } 
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; } 
        .gallery-actions { display: flex; gap: 8px; } 
        .gallery-actions button { 
            padding: 6px 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; 
            background: transparent; color: #888; cursor: pointer; font-size: 0.8rem; transition: all 0.3s; 
        } 
        .gallery-actions button:hover { border-color: #00d4ff; color: #00d4ff; } 
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; } 
        .image-card { 
            background: rgba(0, 0, 0, 0.3); border-radius: 10px; overflow: hidden; 
            border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s; 
        } 
        .image-card:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); border-color: rgba(0, 212, 255, 0.3); } 
        .image-card .image-wrapper { 
            position: relative; aspect-ratio: 1; background: rgba(0, 0, 0, 0.5); 
            display: flex; align-items: center; justify-content: center; 
        } 
        .image-card img { max-width: 100%; max-height: 100%; display: block; cursor: pointer; } 
        .image-card .info { padding: 12px; } 
        .image-card .prompt { 
            font-size: 0.8rem; color: #aaa; display: -webkit-box; -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; 
        } 
        .image-card .meta { 
            display: flex; justify-content: space-between; align-items: center; margin-top: 10px; 
            font-size: 0.75rem; color: #666; 
        } 
        .image-card .meta-info { display: flex; flex-direction: column; gap: 2px; } 
        .image-card .meta-info .duration { color: #00d4ff; } 
        .image-card .actions { display: flex; gap: 6px; } 
        .image-card .actions button { 
            padding: 5px 10px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 5px; 
            background: transparent; color: #aaa; cursor: pointer; font-size: 0.75rem; transition: all 0.3s; 
        } 
        .image-card .actions button:hover { border-color: #00d4ff; color: #00d4ff; } 
        .empty-state { text-align: center; padding: 50px 20px; color: #555; } 
        .empty-state svg { width: 60px; height: 60px; margin-bottom: 15px; opacity: 0.4; } 
        .connection-status { 
            display: flex; align-items: center; gap: 8px; margin-top: 12px; padding: 8px 12px; 
            background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-size: 0.8rem; 
        } 
        .connection-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; } 
        .connection-dot.connected { background: #4caf50; box-shadow: 0 0 8px #4caf50; } 
        .connection-dot.error { background: #ff5252; } 
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.95); z-index: 1000; align-items: center; 
            justify-content: center; flex-direction: column; gap: 15px; 
        } 
        .modal.show { display: flex; } 
        .modal img { max-width: 90%; max-height: 80%; border-radius: 8px; } 
        .modal-info { color: #888; font-size: 0.9rem; text-align: center; } 
        .modal-close { 
            position: absolute; top: 20px; right: 30px; font-size: 2rem; color: #fff; cursor: pointer; opacity: 0.7; 
        } 
        .modal-close:hover { opacity: 1; } 
        .settings-toggle { 
            display: flex; align-items: center; gap: 8px; padding: 8px 0; cursor: pointer; color: #888; 
            font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 12px; 
        } 
        .settings-toggle:hover { color: #ccc; } 
        .settings-content { display: none; } 
        .settings-content.show { display: block; } 
        .collapsible-icon { transition: transform 0.3s; } 
        .settings-toggle.open .collapsible-icon { transform: rotate(180deg); } 
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Z-Image-Turbo</h1>
            <p>Local AI Image Generator</p>
        </header>
        <div class="main-content">
            <div class="controls">
                <div class="panel">
                    <div class="settings-toggle" onclick="toggleSettings()">
                        <span>Settings</span>
                        <span class="collapsible-icon">v</span>
                    </div>
                    <div class="settings-content" id="settingsContent">
                        <div class="form-group">
                            <label>API URL</label>
                            <input type="text" id="apiUrl" value="http://127.0.0.1:8000">
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="password" id="apiKey" value="sk-comfyui-z-image-turbo">
                        </div>
                    </div>
                    <div class="connection-status">
                        <span class="connection-dot" id="connDot"></span>
                        <span id="connText">Checking...</span>
                        <button onclick="checkConnection()" style="margin-left:auto;padding:3px 8px;border:1px solid #444;border-radius:4px;background:transparent;color:#888;cursor:pointer;font-size:0.75rem;">Test</button>
                    </div>
                </div>
                <div class="panel" style="margin-top: 15px;">
                    <h2>Generate</h2>
                    <div class="form-group">
                        <label>Prompt</label>
                        <textarea id="prompt" placeholder="Describe the image...">a cute orange cat sitting on a windowsill, soft morning sunlight, photorealistic, 8k uhd</textarea>
                    </div>
                    <div class="form-group">
                        <label>Aspect Ratio</label>
                        <div class="ratio-tabs">
                            <button class="ratio-tab active" data-ratio="1:1">1:1</button>
                            <button class="ratio-tab" data-ratio="4:3">4:3</button>
                            <button class="ratio-tab" data-ratio="3:4">3:4</button>
                            <button class="ratio-tab" data-ratio="16:9">16:9</button>
                            <button class="ratio-tab" data-ratio="9:16">9:16</button>
                            <button class="ratio-tab" data-ratio="3:2">3:2</button>
                            <button class="ratio-tab" data-ratio="2:3">2:3</button>
                            <button class="ratio-tab" data-ratio="custom">Custom</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Resolution</label>
                        <div class="size-grid" id="sizeGrid"></div>
                    </div>
                    <div class="custom-size" id="customSize">
                        <label style="font-size:0.8rem;color:#888;margin-bottom:8px;display:block;">Custom Resolution</label>
                        <div class="custom-size-inputs">
                            <!-- 加上了 onchange 事件，确保值变了就触发 -->
                            <input type="number" id="customWidth" value="1024" min="256" max="4096" step="64" onchange="applyCustomSize()">
                            <span>x</span>
                            <input type="number" id="customHeight" value="1024" min="256" max="4096" step="64" onchange="applyCustomSize()">
                            <button onclick="applyCustomSize()" style="padding:8px 12px;border:1px solid #00d4ff;border-radius:6px;background:transparent;color:#00d4ff;cursor:pointer;font-size:0.8rem;">Apply</button>
                        </div>
                    </div>
                    <div class="inline-inputs">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Images</label>
                            <select id="numImages">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Current Size</label>
                            <input type="text" id="currentSize" value="1024 x 1024" readonly style="text-align:center;background:rgba(0,212,255,0.1);border-color:rgba(0,212,255,0.3);color:#00d4ff;">
                        </div>
                    </div>
                    <button class="generate-btn" id="generateBtn" onclick="generate()" style="margin-top:16px;">
                        <span>Generate</span>
                    </button>
                    <div class="progress-section" id="progressSection">
                        <div class="progress-header">
                            <span class="progress-status" id="progressStatus">Initializing...</span>
                            <span class="progress-time" id="progressTime">00:00.0</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="progress-steps">
                            <div class="progress-step" id="step1"><span class="step-dot"></span><span>Queue</span></div>
                            <div class="progress-step" id="step2"><span class="step-dot"></span><span>Generate</span></div>
                            <div class="progress-step" id="step3"><span class="step-dot"></span><span>Decode</span></div>
                            <div class="progress-step" id="step4"><span class="step-dot"></span><span>Done</span></div>
                        </div>
                    </div>
                    <div class="status-bar" id="statusBar"></div>
                </div>
            </div>
            <div class="panel gallery">
                <div class="gallery-header">
                    <h2>Gallery (<span id="imageCount">0</span>)</h2>
                    <div class="gallery-actions">
                        <button onclick="downloadAll()">Download All</button>
                        <button onclick="clearGallery()">Clear All</button>
                    </div>
                </div>
                <div class="gallery-grid" id="gallery">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <p>No images yet</p>
                        <p style="font-size:0.85rem;margin-top:5px;">Enter a prompt and click Generate</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="modal" onclick="closeModal()">
        <span class="modal-close">x</span>
        <img id="modalImg" src="" alt="Preview">
        <div class="modal-info" id="modalInfo"></div>
    </div>
    <script>
        const sizePresets = { 
            '1:1': [ 
                { w: 512, h: 512, label: 'Small' }, 
                { w: 768, h: 768, label: 'Medium' }, 
                { w: 1024, h: 1024, label: 'Large' }, 
                { w: 1280, h: 1280, label: 'XL' }, 
                { w: 1536, h: 1536, label: '2K' }, 
            ], 
            '4:3': [ 
                { w: 640, h: 480, label: 'VGA' }, 
                { w: 800, h: 600, label: 'SVGA' }, 
                { w: 1024, h: 768, label: 'XGA' }, 
                { w: 1280, h: 960, label: 'HD' }, 
                { w: 1600, h: 1200, label: '2K' }, 
            ], 
            '3:4': [ 
                { w: 480, h: 640, label: 'VGA' }, 
                { w: 600, h: 800, label: 'SVGA' }, 
                { w: 768, h: 1024, label: 'XGA' }, 
                { w: 960, h: 1280, label: 'HD' }, 
                { w: 1200, h: 1600, label: '2K' }, 
            ], 
            '16:9': [ 
                { w: 640, h: 360, label: 'nHD' }, 
                { w: 960, h: 540, label: 'qHD' }, 
                { w: 1280, h: 720, label: '720p' }, 
                { w: 1600, h: 900, label: 'HD+' }, 
                { w: 1920, h: 1080, label: '1080p' }, 
            ], 
            '9:16': [ 
                { w: 360, h: 640, label: 'nHD' }, 
                { w: 540, h: 960, label: 'qHD' }, 
                { w: 720, h: 1280, label: '720p' }, 
                { w: 900, h: 1600, label: 'HD+' }, 
                { w: 1080, h: 1920, label: '1080p' }, 
            ], 
            '3:2': [ 
                { w: 576, h: 384, label: 'Small' }, 
                { w: 768, h: 512, label: 'Medium' }, 
                { w: 1152, h: 768, label: 'Large' }, 
                { w: 1440, h: 960, label: 'XL' }, 
                { w: 1728, h: 1152, label: '2K' }, 
            ], 
            '2:3': [ 
                { w: 384, h: 576, label: 'Small' }, 
                { w: 512, h: 768, label: 'Medium' }, 
                { w: 768, h: 1152, label: 'Large' }, 
                { w: 960, h: 1440, label: 'XL' }, 
                { w: 1152, h: 1728, label: '2K' }, 
            ], 
        }; 
        let currentRatio = '1:1'; 
        let selectedSize = { w: 1024, h: 1024 }; 
        let generatedImages = []; 
        let generateStartTime = null; 
        let timerInterval = null; 

        window.onload = () => { renderSizeGrid(); setTimeout(checkConnection, 500); }; 

        function toggleSettings() { 
            const c = document.getElementById('settingsContent'); 
            const t = document.querySelector('.settings-toggle'); 
            c.classList.toggle('show'); 
            t.classList.toggle('open'); 
        } 

        document.querySelectorAll('.ratio-tab').forEach(tab => { 
            tab.addEventListener('click', () => { 
                document.querySelectorAll('.ratio-tab').forEach(t => t.classList.remove('active')); 
                tab.classList.add('active'); 
                currentRatio = tab.dataset.ratio; 
                if (currentRatio === 'custom') { 
                    document.getElementById('customSize').classList.add('show'); 
                    // 切换到Custom时，不要立刻重置size，保留用户之前的选择，直到他们输入
                } else { 
                    document.getElementById('customSize').classList.remove('show'); 
                    renderSizeGrid(); 
                } 
            }); 
        }); 

        function renderSizeGrid() { 
            const grid = document.getElementById('sizeGrid'); 
            const presets = sizePresets[currentRatio] || sizePresets['1:1']; 
            grid.innerHTML = presets.map((size, i) => 
                '<button class="size-btn ' + (i === 2 ? 'active' : '') + '" data-w="' + size.w + '" data-h="' + size.h + '" onclick="selectSize(' + size.w + ', ' + size.h + ', this)">' +
                '<span class="dimensions">' + size.w + 'x' + size.h + '</span>' +
                '<span class="label">' + size.label + '</span></button>' 
            ).join(''); 
            if (presets[2]) selectSize(presets[2].w, presets[2].h); 
        } 

        function selectSize(w, h, btn) { 
            selectedSize = { w, h }; 
            document.getElementById('currentSize').value = w + ' x ' + h; 
            // 只有当有特定按钮被点击时，才清除active类，这样自定义输入时不会清除已选样式(虽然自定义输入时这也不重要)
            // 实际上在Custom模式下，SizeGrid是被遮挡或者不重要的，所以这里逻辑没问题
            if (btn) { 
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active')); 
                btn.classList.add('active'); 
            }
        } 

        function applyCustomSize() { 
            const w = parseInt(document.getElementById('customWidth').value); 
            const h = parseInt(document.getElementById('customHeight').value); 
            // 稍微放宽一点检查，确保有效
            if (!isNaN(w) && !isNaN(h) && w >= 64 && h >= 64) { 
                // 调用selectSize但不传btn，这样就不会去误操作预设按钮的样式
                selectSize(w, h); 
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active')); 
            } 
        } 

        async function checkConnection() { 
            const apiUrl = document.getElementById('apiUrl').value; 
            const dot = document.getElementById('connDot'); 
            const text = document.getElementById('connText'); 
            dot.className = 'connection-dot'; 
            text.textContent = 'Checking...'; 
            try { 
                const r = await fetch(apiUrl + '/health', { method: 'GET', mode: 'cors' }); 
                if (r.ok) { 
                    const d = await r.json(); 
                    dot.classList.add('connected'); 
                    text.textContent = 'Connected ' + (d.workflow_loaded ? 'OK' : '(No workflow)'); 
                } else throw new Error(); 
            } catch (e) { 
                dot.classList.add('error'); 
                text.textContent = 'Connection failed'; 
            } 
        } 

        function showProgress() { 
            document.getElementById('progressSection').classList.add('show'); 
            document.getElementById('progressBar').className = 'progress-bar indeterminate'; 
            setStep(1); 
            generateStartTime = Date.now(); 
            updateTimer(); 
            timerInterval = setInterval(updateTimer, 100); 
        } 

        function hideProgress() { 
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } 
        } 

        function updateTimer() { 
            if (!generateStartTime) return; 
            const e = (Date.now() - generateStartTime) / 1000; 
            const m = Math.floor(e / 60).toString().padStart(2, '0'); 
            const s = Math.floor(e % 60).toString().padStart(2, '0'); 
            const ms = Math.floor((e % 1) * 10); 
            document.getElementById('progressTime').textContent = m + ':' + s + '.' + ms; 
        } 

        function setStep(step) { 
            for (let i = 1; i <= 4; i++) { 
                const el = document.getElementById('step' + i); 
                el.className = 'progress-step'; 
                if (i < step) el.classList.add('done'); 
                if (i === step) el.classList.add('active'); 
            } 
            const texts = ['', 'Queuing...', 'Generating...', 'Decoding...', 'Complete!']; 
            document.getElementById('progressStatus').textContent = texts[step] || ''; 
        } 

        function setProgress(p) { 
            const bar = document.getElementById('progressBar'); 
            bar.className = 'progress-bar'; 
            bar.style.width = p + '%'; 
        } 

        function showStatus(msg, type) { 
            const bar = document.getElementById('statusBar'); 
            bar.textContent = msg; 
            bar.className = 'status-bar ' + type; 
        } 

        function hideStatus() { document.getElementById('statusBar').className = 'status-bar'; } 

        async function generate() { 
            const apiUrl = document.getElementById('apiUrl').value; 
            const apiKey = document.getElementById('apiKey').value; 
            const prompt = document.getElementById('prompt').value.trim(); 
            const numImages = parseInt(document.getElementById('numImages').value); 
            const btn = document.getElementById('generateBtn'); 

            // -------------------- 关键修复 --------------------
            // 如果当前是 Customs 模式，强制从输入框读取数值，防止用户忘记点 Apply
            if (currentRatio === 'custom') {
                const w = parseInt(document.getElementById('customWidth').value);
                const h = parseInt(document.getElementById('customHeight').value);
                if (w < 256 || w > 4096 || h < 256 || h > 4096) {
                   showStatus('Custom resolution must be between 256 and 4096', 'error');
                   return; // 阻止后续运行
                }
                selectedSize = { w, h };
                document.getElementById('currentSize').value = w + ' x ' + h; // 顺便把显示也更新了
            }
            // ------------------------------------------------

            if (!prompt) { showStatus('Please enter a prompt', 'error'); return; } 
            btn.disabled = true; 
            btn.innerHTML = '<span>Generating...</span>'; 
            hideStatus(); 
            showProgress(); 
            try { 
                setStep(1); 
                await new Promise(r => setTimeout(r, 200)); 
                setStep(2); 
                const response = await fetch(apiUrl + '/v1/images/generations', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey }, 
                    body: JSON.stringify({ 
                        model: 'z-image-turbo', 
                        prompt: prompt, 
                        size: selectedSize.w + 'x' + selectedSize.h, 
                        n: numImages, 
                        response_format: 'b64_json' 
                    }) 
                }); 
                setStep(3); 
                if (!response.ok) throw new Error(await response.text() || 'HTTP ' + response.status); 
                const data = await response.json(); 
                const duration = ((Date.now() - generateStartTime) / 1000).toFixed(1); 
                setStep(4); 
                setProgress(100); 
                data.data.forEach((img, i) => { 
                    generatedImages.unshift({ 
                        id: Date.now() + i, 
                        b64: img.b64_json, 
                        prompt: prompt, 
                        size: selectedSize.w + 'x' + selectedSize.h, 
                        duration: duration, 
                        time: new Date().toLocaleTimeString() 
                    }); 
                }); 
                renderGallery(); 
                showStatus('Generated ' + data.data.length + ' image(s) in ' + duration + 's', 'success'); 
                setTimeout(hideStatus, 4000); 
            } catch (error) { 
                console.error(error); 
                showStatus('Error: ' + error.message, 'error'); 
            } finally { 
                hideProgress(); 
                btn.disabled = false; 
                btn.innerHTML = '<span>Generate</span>'; 
            } 
        } 

        function renderGallery() { 
            const gallery = document.getElementById('gallery'); 
            document.getElementById('imageCount').textContent = generatedImages.length; 
            if (generatedImages.length === 0) { 
                gallery.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><p>No images yet</p><p style="font-size:0.85rem;margin-top:5px;">Enter a prompt and click Generate</p></div>'; 
                return; 
            } 
            gallery.innerHTML = generatedImages.map(img => 
                '<div class="image-card"><div class="image-wrapper"><img src="data:image/png;base64,' + img.b64 + '" alt="image" onclick="openModal(\'' + img.id + '\')"></div><div class="info"><div class="prompt" title="' + img.prompt.replace(/"/g, '&quot;') + '">' + img.prompt + '</div><div class="meta"><div class="meta-info"><span>' + img.size + '</span><span class="duration">Time: ' + img.duration + 's</span></div><div class="actions"><button onclick="downloadImage(\'' + img.id + '\')">Save</button><button onclick="copyPrompt(\'' + img.id + '\')">Copy</button><button onclick="deleteImage(\'' + img.id + '\')">Del</button></div></div></div></div>' 
            ).join(''); 
        } 

        function downloadImage(id) { 
            const img = generatedImages.find(i => i.id == id); 
            if (!img) return; 
            const link = document.createElement('a'); 
            link.href = 'data:image/png;base64,' + img.b64; 
            link.download = 'z-image-' + id + '.png'; 
            link.click(); 
        } 

        function downloadAll() { 
            generatedImages.forEach((img, i) => setTimeout(() => downloadImage(img.id), i * 200)); 
        } 

        function copyPrompt(id) { 
            const img = generatedImages.find(i => i.id == id); 
            if (!img) return; 
            navigator.clipboard.writeText(img.prompt); 
            showStatus('Prompt copied!', 'success'); 
            setTimeout(hideStatus, 2000); 
        } 

        function deleteImage(id) { 
            generatedImages = generatedImages.filter(i => i.id != id); 
            renderGallery(); 
        } 

        function clearGallery() { 
            if (generatedImages.length && confirm('Clear all images?')) { 
                generatedImages = []; 
                renderGallery(); 
            } 
        } 

        function openModal(id) { 
            const img = generatedImages.find(i => i.id == id); 
            if (!img) return; 
            document.getElementById('modalImg').src = 'data:image/png;base64,' + img.b64; 
            document.getElementById('modalInfo').textContent = img.size + ' | ' + img.duration + 's | ' + img.time; 
            document.getElementById('modal').classList.add('show'); 
        } 

        function closeModal() { document.getElementById('modal').classList.remove('show'); } 
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); }); 
    </script>
</body>
</html>